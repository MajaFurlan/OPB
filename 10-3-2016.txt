10. 3. 2016

JOIN

1.Izpiši imena oseb brez traktorjev.

SELECT * FROM oseba
LEFT JOIN traktor ON lastnik = oseba.id

èe hoèemo izpisat samo osebe, ki nimajo traktorja:
SELECT * FROM oseba
LEFT JOIN traktor ON lastnik = oseba.id
WHERE traktor.id IS NULL

samo stolpec z osebami, prez ostalih
SELECT oseba.* FROM oseba
LEFT JOIN traktor ON lastnik = oseba.id
WHERE traktor.id IS NULL



2.Izpiši vse veljavne pare (ime starša, ime otroka)

SELECT stars.id, stars.ime AS stars, otrok.id, otrok.ime AS otrok
FROM oseba AS stars
JOIN otroci ON stars.id=otroci.stars
JOIN oseba AS otrok ON otrok.id=otroci.otrok



3. Izpiši starše, ki so svojim otrokom kupili traktor, še preden so ti dopolnili 10 let.
Namig: cas1+'10 years'::INTERVAL vrne timestamp, ki opisuje trenutek 10 let po èasu cas1. Timestampe lahko med seboj primerjaš z operatorji <, >, <=, >=.

SELECT DISTINCT stars.*    # DISTINCT da se znebiš da je en napisan 2x
FROM oseba AS stars
JOIN otroci ON stars.id=otroci.stars
JOIN oseba AS otrok ON otrok.id=otroci.otrok
JOIN traktor ON otrok.id=lastnik
WHERE otrok.rojstvo + '10 years'::INTERVAL >nakup



4. Izpiši vse pare (ime osebe, ime starega starša). Za osebe, ki nimajo starih staršev, izpiši par (ime osebe, NULL).

SELECT otrok.ime AS vnuk, stari.ime AS stari_stars
FROM oseba AS stari
JOIN otroci AS o1 ON stari.id = o1.stars
JOIN otroci AS o2 ON o1.otrok = o2.stars
RIGHT JOIN oseba AS otrok ON otrok.id=o2.otrok


-----------------------------------------------------------------------------------------
GROUP BY, HAVING

Še o funkciji count():
Funkcija count() zna šteti na tri razliène naèine:

    count(*) prešteje vse vrstice, tudi takšne z NULL vrednostmi
    count(bla) prešteje vrstice, ki v stolpcu bla nimajo NULL
    count(DISTINCT bla) prešteje število razliènih non-NULL vrednosti v stolpcu bla

1. Za vsako osebo izpiši, koliko otrok ima. Osebe lahko izpišeš kar z IDjem. Oseb, ki nimajo otrok, ne izpisuj.

SELECT stars, count(otrok)
FROM otroci
GROUP BY stars

lahko tudi

SELECT stars, count(*) AS stevilo
FROM otroci
GROUP BY stars



2. Za vsako znamko traktorjev izpiši število takih traktorjev v bazi. Pazi na znamko "Edelstahl". Znamke izpiši z imenom.

SELECT ime, count(traktor.id) AS stevilo
FROM znamka LEFT JOIN traktor ON znamka.id=traktor.znamka
GROUP BY znamka.id, ime



3. Za vsako neprevidno osebo izpiši, koliko rezervnih delov ima v lasti. Neprevidna je oseba, ki ima v lasti najveè en rezervni del. Ne pozabi na osebe, ki nimajo nobenega rezervnega dela. Uporabi funkcijo coalesce, ki morebitno NULL vrednost zamenja s podano konstanto (recimo 0).

SELECT oseba.id, ime, coalesce(sum(stevilo),0) AS stevilo_delov
FROM oseba LEFT JOIN deli ON lastnik=oseba.id
GROUP BY oseba.id, ime
HAVING coalesce(sum(stevilo),0) <= 1



4. Izpiši ime osebe, ki ima najveè vozniških izkušenj. Predpostavljamo, da je vsak lastnik vozil vsakega od svojih traktorjev od dneva nakupa do danes povpreèno 15 minut na dan. Kolièine vozniških izkušenj (števila ur) ni treba izpisovati.

SELECT oseba.id, ime, sum(now() - nakup)/96 AS izkusnje
FROM oseba JOIN traktor ON lastnik=oseba.id
GROUP BY oseba.id, ime
ORDER BY izkusnje DESC
LIMIT 1



5. Vašèani se odloèijo rezervne dele zložiti v skupni fond, iz katerega bo potem vsak po potrebi jemal, ko se mu pokvari traktor. Za vsak tip rezervnega dela izpiši, koliko traktorjev lahko preskrbijo z delom tega tipa. (Štejemo samo prvo okvaro: èe imamo en sam volan za Mercedese in 8 Mercedesov, pa niè drugih traktorjev, lahko z volanom preskrbimo 8 traktorjev, ne enega.)
   Namig: Uporabi count z doloèilom DISTINCT.

SELECT tip,count(DISTINCT traktor.id) AS stevilo  # DISTINCT naredi da vsak traktor šteje samo enkrat
FROM deli JOIN traktor USING (znamka)
GROUP BY tip



6. V obliki dan. mesec. (npr. 19. 7.) izpiši vse datume, na katere imata rojstni dan vsaj dve osebi. Mesec iz datuma dobiš s funkcijo extract(month FROM datumska_vrednost), podobno tudi za dan (glej funkcije za èasovne vrednosti). Spomni se tudi operatorja || za stikanje nizov (t.j. "seštevanje" stringov).

SELECT extract(day FROM rojstvo)|| '. ' || extract(month FROM rojstvo) || '.' AS rojstni_dan
FROM oseba
GROUP BY rojstni_dan
HAVING count(*) >= 2

ali z JOIN-om

SELECT DISTINCT extract(day FROM o1.rojstvo)|| '. ' || extract(month FROM o1.rojstvo) || '.' AS rojstni_dan
FROM oseba AS o1
JOIN oseba AS o2 
ON extract(day FROM o1.rojstvo)|| '. ' || extract(month FROM o1.rojstvo) || '.' = extract(day FROM o2.rojstvo)|| '. ' || extract(month FROM o2.rojstvo) || '.' 
AND o1.id<>o2.id